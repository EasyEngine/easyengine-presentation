<!-- TODO
	1. Font-Awesome Support
	2. PT Sans to Open Sans or some other font
-->
<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>EasyEngine = Easy ( WordPress + Nginx )</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="bower_components/shower-ribbon/styles/screen.css">
	<link rel="stylesheet" href="bower_components/highlightjs/styles/sunburst.css">
	<script src="bower_components/highlightjs/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

	<style type="text/css">
		.aligncenter {text-align: center;}
		.alignleft {float: left; }
		.alignright {float: right;}
		.clear {float: none; clear: both;}
		.slide.no-ribbon:after {visibility: hidden;}
		.slide.shout h2{font-size: 60px}
		.shout p {position: absolute; top: 60%; left: 0; width: 100%; text-align: center; color: #777}
		blockquote {font-size: 35px;}
		.slide pre {font-size: 20px;}
		.slide:after {background: url(pictures/ribbon.svg) no-repeat}
		.full .progress div {border-bottom-color: #060}
		/*00a800}*/
		/*.slide pre code {white-space: pre-wrap}*/
		/*.slide blockquote:before {font-size: 20px}*/
/*

		figcaption {color: #444}
		.full .progress {overflow: hidden;}

		.slide {background: #fff url(pictures/wordcamp-mumbai-footer.jpg) no-repeat right 531px;}
		.small {font-size: 22px}*/
	</style>
</head>
<body class="list">
	<header class="caption">
		<h1>WordPress-Nginx Best Practices. With EasyEngine.</h1>
		<p>by Rahul Bansal (from rtCamp)</p>
	</header>

	<section class="slide no-ribbon aligncenter" id="cover"><div>
			<img src="pictures/nginx-conf-logo.png" alt="nginx.conf 2014"/>
			<h2>WordPress-Nginx Best Practices. With EasyEngine.</h2>
			<p><em> by </em> Rahul Bansal (from rtCamp)</p>
		<style>
			#cover img {margin-bottom:40px; }
			#cover h2{font-size: 40px; }
		</style>
	</div></section>

	<section class="slide shout"><div>
		<h2>WordPress-NGINX Best Practices</h2>
	</div></section>

	<section class="slide"><div>
		<h2>The Rule!</h2>
		<figure>
			<blockquote>
				If you can do it in NGINX, just do it in NGINX!
			</blockquote>
		</figure>
	</div></section>

	<section class="slide shout"><div>
		<h2>#1. nginx fastcgi-cache</h2>
		<p>Full Page-Cache for non-logged in users</p>
	</div></section>

	<section class="slide"><div>
		<h2>Purpose</h2>
		<ul>
			<li>Best solution for serving content to non-logged in users</li>
			<li>Should be used instead full-page-cache from WordPress plugin</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Global Code Fragment</h2>
		<pre>
<code class="nginx">fastcgi_cache_path /var/run/nginx-cache keys_zone=WORDPRESS:100m;</code>
<br/>
<code class="nginx">fastcgi_cache_key "$scheme$request_method$host$request_uri";</code>
<br/>
<code class="nginx">fastcgi_cache_use_stale error updating timeout invalid_header http_500;</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Site Config</h2>
		<pre>
<code class="nginx">location ~ \.php$ {</code>
<code class="nginx">	try_files $uri =404; fastcgi_pass backend;</code>
<code class="nginx">&nbsp;</code>
<code class="nginx">	fastcgi_cache WORDPRESS;</code>
<code class="nginx">	fastcgi_cache_valid  60m;</code>
<code class="nginx">&nbsp;</code>
<code class="nginx">	fastcgi_cache_bypass $skip_cache;</code>
<code class="nginx">	fastcgi_no_cache $skip_cache;</code>
<code class="nginx">}</code>
	</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Cache conditions</h2>
		<pre>
<code class="nginx">set $skip_cache 0;</code>
<code class="nginx">if ($request_method = POST) { set $skip_cache 1; }</code>
<code class="nginx">if ($query_string != "") { set $skip_cache 1; }
<code class="nginx">if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|index.php") {
	set $skip_cache 1;}</code>
<code class="nginx">if ($http_cookie ~* "comment_author|wordpress_logged_in|wordpress_*") {
	set $skip_cache 1;}</code>
	</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Cache conditions</h2>
		<pre>
<code class="nginx">if ($request_uri ~* "<mark class="important">/store/</mark>|<mark class="important">/random/</mark>|/wp-admin/|...") {
	set $skip_cache 1;	}   </code>
<br/>
<code class="nginx">if ($http_cookie ~* "comment_author|<mark class="important">test_cookie</mark>|...") {
	set $skip_cache 1; 	}</code>
<br/>
<code class="nginx">if ($remote_addr ~* "<mark class="important">1.2.3.4</mark>") {
	set $skip_cache 1;	}   </code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Caching search result pages</h2>
		<p>Remember? <code>http://example.com/?s=hello</code></p>
		<pre>
<code class="nginx">if ($query_string != "") {
	set $skip_cache 1; }   </code>
<br/>
<code class="nginx">if ($arg_s != "") {
	set $skip_cache 0; }</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Caching multiple versions of a page</h2>
		<em>Cookie Example</em>
		<pre><code class="nginx">fastcgi_cache_key "$scheme$request_method$host$request_uri$cookie_country";</code>
		</pre>
		<em>User-Agent Example</em>
		<pre><code class="nginx">set $mobile no;
if ($http_user_agent ~* "iphone|android|blackberry|netfront") {
	set $mobile yes;}
fastcgi_cache_key "$scheme$request_method$host$request_uri$mobile";</code>
		</pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>#2. NGINX substitution module</h2>
		<p>CDN &amp; SSL Warning fix</p>
	</div></section>

	<section class="slide"><div>
		<h2>CDN (Origin Pull)</h2>
		<p>
		<em>Original URL</em> <code>example.com/wp-content/uploads/hello.jpg</code>
		<em>CDN URL</em> <code><b>cdn</b>.example.com/wp-content/uploads/hello.jpg</code>
		</p>
		<pre>
<code class="nginx">sub_filter "example.com/wp-content/uploads/"
			 "cdn.example.com/wp-content/uploads/";</code>
<code class="nginx">sub_filter_last_modified on;</code>
<code class="nginx">sub_filter_once off;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>SSL - mixed content warning fix</h2>
		<pre>
<code class="nginx">sub_filter "http://example.com/wp-content/"
	 "https://example.com/wp-content/";</code>
<code class="nginx">sub_filter_last_modified on;</code>
<code class="nginx">sub_filter_once off;</code>
		</pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>#3. pagespeed module</h2>
		<p>Reduce page-load time by huge margin!</p>
	</div></section>

	<section class="slide"><div>
		<h2>pagespeed module</h2>
		<ul>
			<li>css/js minify &amp; combine.</li>
			<li>search-replace URL for CDN</li>
			<li>on the fly image (lossless) compression</li>
			<li>lazy loading for images</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Site-specific Filters</h2>
		<pre><code class="nginx">#For CSS files
pagespeed EnableFilters combine_css,rewrite_css;

# For JavaScript files
pagespeed EnableFilters combine_javascript,rewrite_javascript;

# For Images
pagespeed EnableFilters lazyload_images;
pagespeed EnableFilters rewrite_images;
pagespeed EnableFilters convert_jpeg_to_progressive
</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Global Config</h2>
		<pre><code class="nginx"># Turning the module on and off
pagespeed on;

# Configuring PageSpeed Filters
pagespeed RewriteLevel PassThrough;

# Needs to exist and be writable by nginx. Use tmpfs for best performance.
pagespeed FileCachePath /var/ngx_pagespeed_cache;
</code></pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>#4. Upstream Module</h2>
		<p>Load Balancer/Failover</p>
	</div></section>

	<section class="slide"><div>
		<h2>Load-balance Mode</h2>
<pre><code class="nginx">upstream <mark class="important">backend</mark> {
	<mark>ip_hash</mark>;
	server 1.1.1.1;
	server 2.2.2.2;
	server 2.2.2.2;
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Failover Mode</h2>
<pre><code class="nginx">upstream <mark class="important">backend</mark> {
	server 1.1.1.1;
	server 2.2.2.2 <mark>backup</mark>;
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Front-end Site Config</h2>
<pre><code class="nginx">location / {
	proxy_pass		 http://<mark class="important">backend</mark>;
	proxy_set_header Host              $host;
	proxy_set_header X-Real-IP         $remote_addr;
	proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
	proxy_set_header X-Forwarded-Proto $scheme;
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Backend Nginx Config</h2>
<pre><code class="nginx">#gloabal config
	set_real_ip_from   9.9.9.9;
	real_ip_header     X-Forwarded-For;
}</code></pre>
<p><em> It's recommended to use Nginx on backend servers, even though front-end Nginx can talk to PHP running on backend server directly! </em></p>
	</div></section>

	<section class="slide"><div>
		<h2>What if load balancer fails?</h2>
<li>Configure backend server with Nginx in a way that it can run as standalone server (accessible on port 80).</li>
<li>Use DNS-based failover to switch traffic from load balancer node to backend server(s). Automate this switch by monitoring health of load-balacer!</li>
	</div></section>

	<section class="slide shout"><div>
		<h2>#5. Upstream + HHVM for PHP</h2>
		<p>Speed for logged in users</p>
	</div></section>

	<section class="slide"><div>
		<h2>HHVM with PHP-FPM fallback</h2>
	<pre><code class="nginx">upstream <mark class="important">php</mark> {
		server 127.0.0.1:8000;			#hhvm
		server 127.0.0.1:9000 <mark>backup</mark>;	#php-fpm
	}</code></pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>More Tricks</h2>
		<p>The list is endless!</p>
	</div></section>

	<section class="slide"><div>
		<h2>SSL and spdy</h2>
		<pre><code class="nginx">#enable SSL cache
ssl_session_cache   shared:SSL:20m;
ssl_session_timeout 10m;

#enable spdy
server {
   listen 443 ssl <mark class="important">spdy</mark>;
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>URL Redirection</h2>
		<pre><code class="nginx">#For Single URL
location = /old/path {
	return 301 http://foo.com/new/url;
}

#For Complete Section
location ~ /old/(.*) {
	return 301 http://foo.com/new/$1;
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Security with Limit Request Module</h2>
		<pre><code class="nginx">#global
limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;

#server
location = <mark>/wp-login.php</mark> {
    limit_req  zone=one  burst=1 nodelay;
    include fastcgi_params;
    fastcgi_pass 127.0.0.1:9000;
}
</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Memcache/Redis - Distributed Cache</h2>
		<li>Recommended for a WordPress site spread across multiple servers</li>
		<li>WordPress/PHP side codes are needed to “fill” cache</li>
		<li>For Memcache, NGINX has a core and few third party modules</li>
		<li>For redis, NGINX has third party modules</li>
	</div></section>

<section class="slide shout"><div>
	<h2>EasyEngine</h2>
</div></section>

	<section class="slide"><div>
		<h2>What is EasyEngine?</h2>
		<li>A script to setup and manage multiple wordpress sites with NGINX web server</li>
		<li>Always up to date with best practices, including most of the stuff we discussed so far</li>
	</div></section>

	<section class="slide"><div>
		<h2>Getting Started!</h2>
<pre><code class="bash">#install easy-engine
wget -qO ee rt.cx/ee &amp;&amp; sudo bash ee

#install nginx, php, mysql, postfix
ee stack install

#install WordPress on example.com
ee site create example.com --wpfc
</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>WordPress Multisite Handling</h2>
<pre><code class="bash">#multisite with subdirectory
ee site create example.com --wpfc --wpsubdir

#multisite with subdomain
ee site create example.com --wpfc --wpsubdom
</code></pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>EasyEngine Demo!</h2>
		<p>It's showtime!</p>
	</div></section>

	<section class="slide"><div>
		<h2>EasyEngine Resources</h2>
		<ul>
			<li>Home&nbsp; => <a href="http://rtcamp.com/easyengine">http://rtcamp.com/easyengine</a></li>
			<li>Github => <a href="http://github.com/rtCamp/easyengine">http://github.com/rtCamp/easyengine</a></li>
			<li>Forum  => <a href="http://community.rtcamp.com/category/easyengine/">http://community.rtcamp.com/category/easyengine/</a></li>
		</ul>
	</div></section>


	<section class="slide shout"><div>
		<h2>Thanks! :-)</h2>
		<p>mailto: <a href="mailto:rahul.bansal@rtcamp.com">rahul.bansal@rtcamp.com</a></p>
	</div></section>

	<div class="progress"><div></div></div>
	<script src="bower_components/shower-core/shower.min.js"></script>
	<script src="http://localhost:35729/livereload.js"></script>
	<!-- Copyright © 2013 Yours Truly, Famous Inc. -->
	<!-- Photos by John Carey, fiftyfootshadows.net -->
</body>
</html><li></li>
