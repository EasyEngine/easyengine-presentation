<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>EasyEngine = Easy ( WordPress + NGINX )</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">

	<link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="bower_components/highlightjs/styles/idea.css">
	<link rel="stylesheet" href="ribbon/styles/screen.css">
	<link rel="stylesheet" href="main.css">

	<script src="bower_components/highlightjs/highlight.pack.js"></script>
	<!-- Comment following line in case syntax highlighting creates problem -->
	<script>hljs.initHighlightingOnLoad();</script>
</head>

<body class="list">
	<header class="caption">
		<h1>WordPress-NGINX Best Practices. With EasyEngine.</h1>
		<p>by Rahul Bansal (from rtCamp)</p>
	</header>

	<section class="slide no-ribbon aligncenter" id="cover"><div>
				<img src="pictures/nginx-conf-logo-big.png" alt="nginx.conf 2014"/>
				<h2>WordPress-NGINX Best Practices. With EasyEngine.</h2>
				<p>- Rahul Bansal (from rtCamp)</p>
				<img src="pictures/rtCamp-logo-128x128-blue.png" height="80px" alt="rtCamp logo">
			<style>
				#cover img {margin-bottom:40px; }
			</style>
	</div></section>

	<section class="slide"><div>
		<h2>About me!</h2>
		<div class="aligncenter">
			<p>I am, <mark>Rahul Bansal</mark>, from <mark>rtCamp</mark> India!</p>
			<p>Devleoping on WordPress from 2007!</p>
			<p>Using NGINX from 2009!</p>
			<p>Solving on <mark>WordPress-NGINX</mark> problems from 2010!</p>
			<p>Released EasyEngine in 2013!</p>
		</div>
	</div></section>

	<section class="slide shout"><div>
		<h2>WordPress-NGINX Best Practices</h2>
		<p>fastcgi-cache, pagespeed, upstream/hhvm &amp; more</p>
	</div></section>

	<section class="slide"><div>
		<h2>The Rule!</h2>
		<br/>&nbsp;<br/>
		<blockquote class="aligncenter">
			If you can do it in NGINX, just do it in NGINX!
		</blockquote>
	</div></section>

	<section class="slide shout"><div>
		<h2>#1. NGINX fastcgi-cache</h2>
		<p>Full Page-Cache for non-logged in users</p>
	</div></section>

	<section class="slide"><div>
		<h2>Purpose</h2>
		<ul>
			<li>Serve cached content to non-logged in users. This is to reduce load on backend PHP-MySQL.</li><br/>
			<li>Should be used instead full-page-cache WordPress plugin. WordPress is already doing a lot!</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Global Code Fragment</h2>
		<pre>
<code class="nginx">fastcgi_cache_path
	/var/run/nginx-cache keys_zone=<mark class="important">WORDPRESS</mark>:100m;</code>
<br/>
<code class="nginx">fastcgi_cache_key
	"$scheme$request_method$host$request_uri";</code>
<br/>
<code class="nginx">fastcgi_cache_use_stale
	error updating timeout invalid_header http_500;</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Site/Virtual Host Config</h2>
		<pre>
<code class="nginx">location ~ \.php$ {</code>
<code class="nginx">	try_files $uri =404; fastcgi_pass backend;</code>
<br/>
<code class="nginx">	fastcgi_cache <mark class="important">WORDPRESS</mark>;</code>
<code class="nginx">	fastcgi_cache_valid  60m;</code>
<br/>
<code class="nginx">	fastcgi_cache_bypass $skip_cache;</code>
<code class="nginx">	fastcgi_no_cache $skip_cache;</code>
<code class="nginx">}</code>
	</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Cache conditions</h2>
		<pre>
<code class="nginx">set $skip_cache <mark>0</mark>;</code>
<code class="nginx">if ($request_method = POST ) {
	set $skip_cache 1; }</code>
<code class="nginx">if ($query_string != "" ) {
	set $skip_cache 1; }</code>
<code class="nginx">if ($request_uri ~* "/wp-admin|index.php|wp-.*.php" ) {
	set $skip_cache 1;}</code>
<code class="nginx ">if ($http_cookie ~* "comment_author|wordpress_*" ) {
	set $skip_cache 1;}</code>
	</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Cache conditions</h2>
		<pre>
<code class="nginx">if ($request_uri ~* "<mark>/store/</mark>|/wp-admin/|..." ) {
	set $skip_cache 1;	}   </code>
<br/>
<code class="nginx">if ($http_cookie ~* "comment_author|<mark>test_cookie</mark>|..." ) {
	set $skip_cache 1; 	}</code>
<br/>
<code class="nginx">if ($remote_addr ~* "<mark>1.2.3.4</mark>" ) {
	set $skip_cache 1;	}   </code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Caching search result pages</h2>
		<p><span class="fa fa-link"></span> <code>http://example.com/?s=hello</code></p>
		<pre>
<code class="nginx">if ($query_string 	!= "") 	{ set $skip_cache 1; }   </code>
<code class="nginx">if ($arg_s 			!= "") 	{ set $skip_cache 0; }</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Caching multiple versions of a page</h2>
		<h3>Cookie Example</h3>
		<pre><code class="nginx">fastcgi_cache_key
	 	"$scheme$request_method$host$request_uri<mark>$cookie_country</mark>";</code>
		</pre>
			<h3>User-Agent Example</h3>
			<pre><code class="nginx">set $mobile no;</code>
	<code class="nginx">if ($http_user_agent ~* "iphone|android|...") {
		set $mobile yes;}</code>
	<code class="nginx">fastcgi_cache_key
		"$scheme$request_method$host$request_uri<mark>$mobile</mark>";</code>
			</pre>

	</div></section>

	<section class="slide shout"><div>
		<h2>#2. pagespeed module</h2>
		<p>Reduce page-load time by huge margin!</p>
	</div></section>

	<section class="slide"><div>
		<h2>pagespeed module</h2>
		<ul>
			<li>css/js minify &amp; combine.</li>
			<li>search-replace URL for CDN</li>
			<li>on the fly image (lossless) compression</li>
			<li>lazy loading for images</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Global Config</h2>
		<pre><code class="nginx"># Turning the module on and off
pagespeed on;

# Disable All PageSpeed Filters by default
pagespeed RewriteLevel PassThrough;

# Need to exist and writable by nginx.
pagespeed FileCachePath /var/ngx_pagespeed_cache;
	</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Site-specific Filters</h2>
		<pre><code class="nginx">#For CSS files
pagespeed EnableFilters combine_css,rewrite_css;
# For JavaScript files
pagespeed EnableFilters combine_javascript,rewrite_javascript;

# For Images
pagespeed EnableFilters lazyload_images;
pagespeed EnableFilters rewrite_images;
pagespeed EnableFilters convert_jpeg_to_progressive;
</code></pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>#3. Upstream Module</h2>
		<p>Load Balancer/Failover</p>
	</div></section>

	<section class="slide"><div>
		<h2>Load-balance Mode</h2>
<pre><code class="nginx">upstream <mark class="important">backend</mark> {
	<mark>ip_hash</mark>;
	server 1.1.1.1;
	server 2.2.2.2;
	server 2.2.2.2;
}</code></pre>
<p><em> All backend servers will share (balance) overall load. </em></p>
	</div></section>

	<section class="slide"><div>
		<h2>Failover Mode</h2>
<pre><code class="nginx">upstream <mark class="important">backend</mark> {
	server 1.1.1.1;
	server 2.2.2.2 <mark>backup</mark>;
}</code></pre>
<p><em> "backup" server will get requests only when other (primary) server fails. </em></p>
	</div></section>

	<section class="slide"><div>
		<h2>Front-end Site Config</h2>
<pre><code class="nginx">location / {
	proxy_pass		 http://<mark class="important">backend</mark>;
	proxy_set_header Host              $host;
	proxy_set_header X-Real-IP         $remote_addr;
	proxy_set_header X-Forwarded-For
									$proxy_add_x_forwarded_for;
	proxy_set_header X-Forwarded-Proto $scheme;
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Backend Nginx Config</h2>
<pre><code class="nginx">#gloabal config
	set_real_ip_from   9.9.9.9;
	real_ip_header     X-Forwarded-For;
}</code></pre>
<p><em> It's recommended to use Nginx on backend servers, even though front-end Nginx can talk to PHP running on backend server directly! </em></p>
	</div></section>

	<section class="slide"><div>
		<h2>What if load balancer fails?</h2>
		<br/>
		<blockquote >
			Who will guard the guards themselves!</span>
		</blockquote>
		<br/>
		<ul>
			<li>Configure backend server with Nginx in a way that it can run as standalone server (accessible on port 80).</li>
			<li>Use DNS-based failover to switch traffic from load balancer node to backend server(s). Automate this switch by monitoring health of load-balacer!</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>HHVM with PHP-FPM fallback</h2>
		<p>Speed for logged in users</p>
<pre><code class="nginx">upstream <mark class="important">php</mark> {
	server 127.0.0.1:8000;			#hhvm
	server 127.0.0.1:9000 <mark>backup</mark>;	#php-fpm
}</code></pre>
<p><em>hhvm and php-fpm started on same server but on different ports</em></p>
	</div></section>

	<section class="slide shout"><div>
		<h2>More Tricks</h2>
		<p>The list is endless!</p>
	</div></section>

	<section class="slide"><div>
		<h2>CDN with NGINX substitution module</h2>
		<pre><code class="no-highlight">	 example.com/wp-content/uploads/hello.jpg
					&#x25BC;
	<mark class="important">cdn</mark>.example.com/wp-content/uploads/hello.jpg</code></pre>
		<hr/>
		<pre>
	<code class="nginx">sub_filter "example.com/wp-content/uploads/"
			"cdn.example.com/wp-content/uploads/";</code>
	<code class="nginx">sub_filter_last_modified on;</code>
	<code class="nginx">sub_filter_once off;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>SSL - mixed content warning fix w/ substitution mod</h2>
		<pre>
	<code class="nginx">sub_filter "http://example.com/wp-content/"
	"https://example.com/wp-content/";</code>
	<code class="nginx">sub_filter_last_modified on;</code>
	<code class="nginx">sub_filter_once off;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>SSL and spdy</h2>
		<pre><code class="nginx">#enable SSL cache
ssl_session_cache   shared:SSL:20m;
ssl_session_timeout 10m;

#enable spdy
server {
   listen 443 ssl <mark class="important">spdy</mark>;
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>URL Redirection</h2>
		<pre><code class="nginx">#For Single URL
location = /old/path {
	return 301 http://foo.com/new/url;
}

#For Complete Section
location ~ /old/(.*) {
	return 301 http://foo.com/new/$1;
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Security with Limit Request Module</h2>
		<pre><code class="nginx">#global
limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;

#server
location = <mark>/wp-login.php</mark> {
    limit_req  zone=one  burst=1 nodelay;
    include fastcgi_params;
    fastcgi_pass 127.0.0.1:9000;
}
</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Memcache/Redis - Distributed Cache</h2>
		<ul>
			<li>Recommended for a WordPress site spread across multiple servers</li>
			<li>WordPress/PHP side codes are needed to “fill” cache</li>
			<li>For Memcache, NGINX has a core and few third party modules</li>
			<li>For redis, NGINX has third party modules</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>What we achieved with golden rule!</h2>
		<table>
			<tr><th>task/requirement</th><th>nginx feature/mod</th></tr>
			<tr><td>full page-cache</td><td>fastcgi-cache</td></tr>
			<tr><td>cdn (origin pull)</td><td>sub-filter, pagespeed</td></tr>
			<tr><td>css/js minify &amp; combine</td><td>pagespeed</td></tr>
			<tr><td>image optimize/lazyload</td><td>pagespeed</td></tr>
			<tr><td>URL redirection</td><td>location+return, rewrite</td></tr>
			<tr><td>bruteforce login attack</td><td>limit request module</td></tr>
		</table>
	</div></section>

	<section class="slide"><div>
		<h2>WordPress-Nginx Resources</h2>
		<ul>
			<li><a hreaf="https://rtcamp.com/wordpress-nginx/tutorials/">https://rtcamp.com/wordpress-nginx/tutorials/</a></li>
			<li><a hreaf="https://rtcamp.com/tutorials/nginx">https://rtcamp.com/tutorials/nginx</a></li>
			<li><a hreaf="https://rtcamp.com/tutorials/linux/sysctl-conf/">https://rtcamp.com/tutorials/linux/sysctl-conf/</a></li>
			<li><a hreaf="http://community.rtcamp.com/category/wordpress-nginx">http://community.rtcamp.com/category/wordpress-nginx</a></li>
		</ul>
	</div></section>

	<section class="slide shout"><div>
		<h2>EasyEngine</h2>
		<p>Making WordPress-Nginx Easy!</p>
	</div></section>

	<section class="slide"><div>
		<h2>What is EasyEngine?</h2>
		<ul>
			<li>Command-line script to manage multiple WordPress sites with Nginx</li>
			<li>Automatically install latest nginx, php, mysql, and other packages with commonly used modules and tweak config based on CPU cores and RAM</li>
			<li>Installs and configures plenty of web-based tools system admins</li>
			<li>Always up to date with best practices, including most of the stuff we discussed so far!</li>
		</ul>
	</div></section>

	<section class="slide bigger"><div>
		<h2>Getting Started!</h2>
<pre><code class="bash">#install easy-engine
wget -qO ee rt.cx/ee &amp;&amp; sudo bash ee

#install WordPress on example.com
ee site create example.com --wpfc
</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>WordPress Multisite Handling</h2>
<pre><code class="bash">#multisite with subdirectory
ee site create example.com --wpfc --wpsubdir

#multisite with subdomain
ee site create example.com --wpfc --wpsubdom
</code></pre>
	</div></section>

	<section class="slide" id="table"><div>
		<h2>Create "12" Types of WordPress Sites</h2>
		<table>
		<tr>
			<th scope="col"><!-- What you want? --></th>
			<th>Single Site</th>
			<th>Multisite with Subdir</th>
			<th>Multisite with Subdom</th>
		</tr>
		<tr>
			<th scope="row">Nginx FastCGI Cache</th>
			<td><code>--wpfc</code></td>
			<td><code>--wpfc --wpsubdir</code></td>
			<td><code>--wpfc --wpsubdom</code></td>
		</tr>
		<tr>
			<th scope="row">WP Super Cache</th>
			<td><code>--wpsc </code></td>
			<td><code>--wpsc --wpsubdir</code></td>
			<td><code>--wpsc --wpsubdom</code></td>
		</tr>
		<tr>
			<th scope="row">W3 Total Cache</th>
			<td><code>--w3tc </code></td>
			<td><code>--w3tc --wpsubdir</code></td>
			<td><code>--w3tc --wpsubdom</code></td>
		</tr>
		<tr>
			<th scope="row">NO Cache</th>
			<td><code>--wp</code></td>
			<td><code>--wpsubdir</code></td>
			<td><code>--wpsubdom</code></td>
		</tr>
		</table>
		<h3 class="aligncenter"><b>Change site type on the fly!</b></h3><br/>
		<pre><code class="no-highlight aligncenter">ee site update example.com --wp --wpfc</code></pre>
		<style type="text/css">
			#table code {background: #f1f1f1}
			#table {font-size: 20px}
			#table td {padding: 10px}
			#table th {font-weight: 400}
		</style>
	</div></section>

	<section class="slide shout"><div>
		<h2>EasyEngine Demo!</h2>
		<p>It's showtime!</p>
	</div></section>

	<section class="slide"><div>
		<h2>EasyEngine Resources</h2>
		<span class="fa fa-fw fa-home"></span>
			<a href="http://rtcamp.com/easyengine">http://rtcamp.com/easyengine</a>
		<br/>
		<span class="fa fa-fw fa-github"></span>
<a href="http://community.rtcamp.com/category/easyengine/">http://community.rtcamp.com/category/easyengine/</a>
		<br/>
		<span class="fa fa-fw fa-group"></span>
		 	<a href="http://github.com/rtCamp/easyengine">http://github.com/rtCamp/easyengine</a>
		<br/>
		<span class="fa fa-fw fa-twitter"></span>
		 	<a href="http://twitter.com/easyengine">@easyengine</a>
		<br/>
	</div></section>


	<section class="slide shout"><div>
		<h2>Thanks! <span class="fa fa-smile-o"></span></h2>
		<p>mailto: <a href="mailto:rahul.bansal@rtcamp.com">rahul@rtcamp.com</a></p>
	</div></section>

	<div class="progress"><div></div></div>
	<script src="bower_components/shower-core/shower.min.js"></script>
	<script src="http://localhost:35729/livereload.js"></script>
</body>
</html>
